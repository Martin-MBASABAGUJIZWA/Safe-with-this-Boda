@page "/Drivers"
@using System.ComponentModel.DataAnnotations
@using SafeBoda.Admin.Services
@inherits LayoutComponentBase
@inject DriverService DriverService

<style>
  :root{
    --accent:#FF7D00; --accent-dark:#E66A00; --muted:#6b7280; --bg:#f4f6f8; --surface:#ffffff; 
    --card-radius:12px; --box-shadow:0 6px 18px rgba(15,23,42,0.06);
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  }
  .app{display:grid;grid-template-columns:260px 1fr;gap:24px;min-height:100vh;padding:18px}
  .sidebar{padding:20px;background:linear-gradient(180deg,#fff,#fbfff9);border-radius:var(--card-radius);box-shadow:var();height:calc(100vh - 36px);position:sticky;top:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:18px;color:var(--accent);margin:0}
  .nav{display:flex;flex-direction:column;margin-top:12px}
  .nav a{padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--muted)}
  .nav a.active{background:var(--accent);color:#fff;font-weight:600}
  .download{margin-top:auto;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;padding:10px;border-radius:12px;text-align:center;font-weight:600}

  .main{padding:10px 6px}
  .controls{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .filters{display:flex;gap:10px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:13px}
  input.search{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);min-width:260px}
  .cards{display:flex;gap:18px;margin-top:16px}
  .card{flex:1;background:var(--surface);border-radius:12px;padding:14px;box-shadow:var();display:flex;align-items:center;gap:12px}
  table{width:100%;border-collapse:collapse;margin-top:18px}
  th,td{padding:12px 10px;text-align:left;border-bottom:1px solid rgba(15,23,42,0.05)}
  th{color:var(--muted);font-weight:600;font-size:13px}
  .actions{display:flex;gap:8px}
  button.btn{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border:0}
  button.danger{background:#fde8e6;color:#b91c1c;border:0}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;padding:18px}
  .modal{background:var(--surface);padding:18px;border-radius:12px;max-width:560px;width:100%;box-shadow:0 30px 60px rgba(2,6,23,0.3)}
  .form-row{display:flex;gap:10px;margin-bottom:10px}
  .form-row input, .form-row select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.08)}
  .small{font-size:13px;color:var(--muted)}

  @@media (max-width:900px){.app{grid-template-columns:1fr}.sidebar{position:relative;height:auto}}
</style>

<div class="app">
 

  <main class="main">

    <div class="controls">
      <div class="filters">
        <div class="chip">Role: Driver</div>
        <div class="chip">Vehicle: Any</div>
        <div class="chip">Status: All</div>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <input class="search" @bind="searchText" placeholder="Search Driver by name or phone" />
        <button class="btn primary" @onclick="OpenAdd">+ Add Driver</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,#4f46e5,#2563eb)"></div>
        <div>
          <div style="font-size:22px;font-weight:700">@_drivers.Count</div>
          <div class="small">Total Drivers</div>
        </div>
      </div>

      <div class="card">
        <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,#06b6d4,#0891b2)"></div>
        <div>
          <div style="font-size:22px;font-weight:700">@_drivers.Count</div>
          <div class="small">Total</div>
        </div>
      </div>

      <div class="card">
        <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,#f59e0b,#f97316)"></div>
        <div>
          <div style="font-size:22px;font-weight:700">@_drivers.Count</div>
          <div class="small">Active</div>
        </div>
      </div>
    </div>

    <section class="panel">
      <h2>Drivers</h2>
      <p class="small">Manage Drivers: edit details, rename, suspend or delete accounts.</p>

      <table aria-label="Drivers table">
        <thead>
          <tr>
            <th>#</th><th>Name</th><th>Phone</th><th>Vehicle</th>
            <th>Status</th><th>Joined</th><th>Actions</th>
          </tr>
        </thead>

        <tbody>
@foreach (var d in FilteredDrivers)
{
          <tr>
            <td>@d.Id</td>
            <td>@d.Name</td>
            <td>@d.PhoneNumber</td>
            <td>@d.MotoPlateNumber</td>
            <td>OnDuty</td>
            <td>@DateTime.Now.ToString("MM/dd/yyyy")</td>

            <td>
              <div class="actions">
                <button class="btn" @onclick="() => OpenEdit(d.Id.GetHashCode())">Edit</button>
                <button class="btn danger" @onclick="() => ConfirmDelete(d.Id.GetHashCode())">Delete</button>
              </div>
            </td>
          </tr>
}
        </tbody>
      </table>
    </section>

    <!-- MODAL -->
    @if (showModal)
    {
      <div class="modal-backdrop">
        <div class="modal">
          <h3>@(isEditing ? "Edit Driver" : "Add Driver")</h3>

          <EditForm Model="editModel" OnValidSubmit="SaveDriver">
            <div class="form-row">
              <InputText @bind-Value="editModel.Name" placeholder="Full Name" />
              <InputText @bind-Value="editModel.Phone" placeholder="Phone" />
            </div>

            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
              <button class="btn" @onclick="CloseModal" type="button">Cancel</button>
              <button class="btn primary" type="submit">Save</button>
            </div>
          </EditForm>
        </div>
      </div>
    }

  </main>
</div>

@code {

    string searchText = "";

    bool showModal = false;
    bool isEditing = false;

    DriverEditModel editModel = new();

    // Drivers list from API
    private List<DriverDto> _drivers = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDriversAsync();
    }

    private async Task LoadDriversAsync()
    {
        try
        {
            var drivers = await DriverService.GetAllDriversAsync();
            if (drivers != null)
            {
                _drivers = drivers.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load drivers: {ex.Message}");
            _drivers = new();
        }
    }

    IEnumerable<DriverDto> FilteredDrivers =>
        string.IsNullOrWhiteSpace(searchText)
            ? _drivers.OrderBy(d => d.Id)
            : _drivers.Where(d =>
                d.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                d.PhoneNumber.Contains(searchText));

    void OpenAdd()
    {
        isEditing = false;
        editModel = new DriverEditModel();
        showModal = true;
    }

    void OpenEdit(int id)
    {
        isEditing = true;
        var original = _drivers.FirstOrDefault(d => d.Id.GetHashCode() == id);
        if (original != null)
        {
            editModel = new DriverEditModel { Id = id, Name = original.Name, Phone = original.PhoneNumber };
        }
        showModal = true;
    }

    void RenameDriver(int id) { }
    void ToggleSuspend(int id) { }

    async Task ConfirmDelete(int id)
    {
        try
        {
            var originalDriver = _drivers.FirstOrDefault(d => d.Id.GetHashCode() == id);
            if (originalDriver != null)
            {
                await DriverService.DeleteDriverAsync(originalDriver.Id);
                await LoadDriversAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to delete driver: {ex.Message}");
        }
    }

    async Task SaveDriver()
    {
        try
        {
            if (isEditing)
            {
                // Get original driver ID from existing list
                var originalDriver = _drivers.FirstOrDefault(d => d.Id.GetHashCode() == editModel.Id);
                if (originalDriver != null)
                {
                    await DriverService.UpdateDriverAsync(originalDriver.Id, editModel.Name, editModel.Phone, "");
                }
            }
            else
            {
                await DriverService.CreateDriverAsync(editModel.Name, editModel.Phone, "");
            }
            await LoadDriversAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save driver: {ex.Message}");
        }
        CloseModal();
    }

    void CloseModal() => showModal = false;

    // Simple edit model for form
    public class DriverEditModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
    }
}
